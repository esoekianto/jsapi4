<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="initial-scale=1, maximum-scale=1, user-scalable=no">
<title>Route Task</title></p>
<style>
  html, body {
    padding: 0;
    margin: 0;
  }
</style>
<link rel="stylesheet" href="https://jsdev.arcgis.com/4.0beta2/esri/css/main.css">
<script src="https://jsdev.arcgis.com/4.0beta2/"></script>
<script>
require([
  "esri/Map",
  "esri/views/MapView",
  "esri/Graphic", 
  "esri/layers/GraphicsLayer",           
  "esri/tasks/RouteTask",            
  "esri/tasks/support/RouteParameters",
  "esri/tasks/support/FeatureSet",
  "esri/symbols/SimpleMarkerSymbol",
  "esri/symbols/SimpleLineSymbol",  
   "dojo/on", 
  "dojo/domReady!"
], function(
  Map, MapView, Graphic,  GraphicsLayer, RouteTask, RouteParameters, FeatureSet, SimpleMarkerSymbol, SimpleLineSymbol, on){
  
var map, routeTask, routeParams;
        var stopSymbol, routeSymbol, lastStop;

  var map = new Map({
    basemap: "streets"
  });
  var view = new MapView({
    container: "viewDiv",  //reference to the scene div created in step 5
    map: map,  //reference to the map object created before the scene
     center : [-117.195, 34.057],
            zoom : 14
  });

graphicsLayer = new GraphicsLayer();
        map.add(graphicsLayer);

        routeParams = new RouteParameters();
  routeParams.stops = new FeatureSet();
  routeParams.outSpatialReference = {
    "wkid" : 102100
  };

  stopSymbol = new SimpleMarkerSymbol();
        stopSymbol.style = SimpleMarkerSymbol.STYLE_CROSS;
        stopSymbol.size = 15;
        //stopSymbol.outline.setWidth(4);
        lineSymbol = new SimpleLineSymbol();
        lineSymbol.Color = new dojo.Color([0, 0, 255, 0.5]);
        lineSymbol.Width = 5;
        routeSymbol = lineSymbol;

  view.then(function() {


        
        on(view, "click", addStop);

       routeTask = new RouteTask("http://route.arcgis.com/arcgis/rest/services/World/Route/NAServer/Route_World");

       on(routeTask, "solve-compelte", showRoute);
       // routeTask.on("error", errorHandler);       

        
  });


  //Adds a graphic when the user clicks the map. If 2 or more points exist, route is solved.
  function addStop(evt) {
    var stop = new Graphic(evt.mapPoint, stopSymbol);
    graphicsLayer.add(stop);
    routeParams.stops.features.push(stop);

    if (routeParams.stops.features.length >= 2) {
      routeTask.solve(routeParams).then(showRoute);
      lastStop = routeParams.stops.features.splice(0, 1)[0];
    }
  }

  function showRoute(evt) {
          var routeResult = evt.routeResults[0].route;
          routeResult.symbol = routeSymbol;
          graphicsLayer.add(routeResult);
  }
});
</script>
</head>
<body>
  <p>Click on the map to add stops to the route. The route from the last stop to the newly added stop is calculated. If a stop is not reachable, it is removed and the last valid point is set as the starting point.</p>
  <div id="viewDiv"></div>
</body>
</html>
